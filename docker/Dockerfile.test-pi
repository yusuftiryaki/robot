# 妒 OBA Test Environment - Raspberry Pi Sim羹lat繹r羹
# Deployment script'lerini test etmek i癟in SSH container

FROM ubuntu:22.04

# Timezone ayarla (interactive prompt'u 繹nle)
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=Europe/Istanbul

# SSH server ve temel ara癟lar覺 y羹kle
RUN apt-get update && apt-get install -y \
    openssh-server \
    sudo \
    curl \
    wget \
    git \
    python3 \
    python3-pip \
    python3-venv \
    i2c-tools \
    nano \
    net-tools \
    htop \
    build-essential \
    cmake \
    pkg-config \
    libjpeg-dev \
    libtiff5-dev \
    libpng-dev \
    libavcodec-dev \
    libavformat-dev \
    libswscale-dev \
    libv4l-dev \
    libxvidcore-dev \
    libx264-dev \
    libatlas-base-dev \
    gfortran \
    libhdf5-dev \
    libhdf5-serial-dev \
    python3-dev \
    ufw \
    && rm -rf /var/lib/apt/lists/*

# SSH i癟in gerekli dizinleri olutur
RUN mkdir /var/run/sshd

# Test kullan覺c覺s覺 olutur (Raspberry Pi'deki gibi)
RUN useradd -m -s /bin/bash pi && \
    echo 'pi:raspberry' | chpasswd && \
    usermod -aG sudo pi && \
    echo 'pi ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers

# Root ifresi ayarla (opsiyonel)
RUN echo 'root:toor' | chpasswd

# SSH ayarlar覺 - g羹venlik i癟in production'da deitirin
RUN sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config && \
    sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config && \
    sed -i 's/#PubkeyAuthentication yes/PubkeyAuthentication yes/' /etc/ssh/sshd_config

# GPIO gruplar覺n覺 sim羹le et (Raspberry Pi uyumluluu i癟in)
# Mevcut gruplar覺 kontrol et ve yoksa olutur
RUN groupadd -f gpio && \
    groupadd -f i2c && \
    groupadd -f spi && \
    groupadd -f video && \
    groupadd -f input && \
    usermod -aG gpio,i2c,spi,video,input pi

# Raspberry Pi benzeri /dev dosyalar覺 olutur
RUN mkdir -p /dev && \
    touch /dev/i2c-1 /dev/spidev0.0 /dev/video0 && \
    chmod 666 /dev/i2c-1 /dev/spidev0.0 /dev/video0

# Raspberry Pi config tool sim羹lasyonu
RUN echo '#!/bin/bash' > /usr/bin/raspi-config && \
    echo 'echo "Simulated raspi-config: $@"' >> /usr/bin/raspi-config && \
    echo 'exit 0' >> /usr/bin/raspi-config && \
    chmod +x /usr/bin/raspi-config

# OS release bilgisini Raspberry Pi'ye benzet
RUN echo 'PRETTY_NAME="Raspberry Pi OS Lite (Test Environment)"' > /etc/os-release && \
    echo 'NAME="Raspberry Pi OS"' >> /etc/os-release && \
    echo 'VERSION_ID="11"' >> /etc/os-release && \
    echo 'VERSION="11 (bullseye)"' >> /etc/os-release && \
    echo 'ID=raspbian' >> /etc/os-release

# SSH anahtar覺 olutur
RUN ssh-keygen -A

# Test i癟in port'lar覺 expose et
EXPOSE 22 8080

# Balang覺癟 script'i
COPY docker/start-test-env.sh /start-test-env.sh
RUN chmod +x /start-test-env.sh

# al覺ma dizini
WORKDIR /home/pi

# Container balat覺ld覺覺nda SSH daemon'覺 癟al覺t覺r
CMD ["/start-test-env.sh"]

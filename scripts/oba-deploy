#!/bin/bash
# ğŸš€ OBA Robot - Otomatik Raspberry Pi Deployment Script
# HacÄ± Abi'nin sihirli deployment aracÄ±!
#
# KullanÄ±m:
#   oba-deploy --ip 192.168.1.100 --password mypassword
#   oba-deploy    # Test environment iÃ§in otomatik tespit (dinamik IP)

set -euo pipefail  # Strict mode

# Renkler ve semboller
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly CYAN='\033[0;36m'
readonly NC='\033[0m' # No Color

# VarsayÄ±lan deÄŸerler
PI_IP=""
PI_PASSWORD=""
PI_USER="pi"
SSH_PORT="22"
REPO_URL="https://github.com/yusuftiryaki/robot.git"  # Bu URL'yi gÃ¼ncelleyin
BRANCH="main"
SKIP_SYSTEM_UPDATE=false
SKIP_HARDWARE_TEST=false
DRY_RUN=false
VERBOSE=false
USE_SCP_COPY=false

# Script bilgileri
readonly SCRIPT_NAME="$(basename "$0")"
readonly SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
readonly PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# Log fonksiyonlarÄ±
log_info() {
    echo -e "${GREEN}â„¹ï¸  $1${NC}"
}

log_warn() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

log_error() {
    echo -e "${RED}âŒ $1${NC}"
}

log_step() {
    echo -e "${CYAN}ğŸ”„ $1${NC}"
}

log_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

log_debug() {
    if [[ "$VERBOSE" == "true" ]]; then
        echo -e "${BLUE}ğŸ” DEBUG: $1${NC}" >&2
    fi
}

# YardÄ±m mesajÄ±
show_help() {
    cat << EOF
ğŸš€ OBA Robot - Otomatik Raspberry Pi Deployment
=============================================

Bu script OBA robot'unu Raspberry Pi'ye otomatik olarak kurar.

KULLANIM:
    $SCRIPT_NAME --ip <PI_IP> --password <PASSWORD> [SEÃ‡ENEKLER]

ZORUNLU PARAMETRELER:
    -i, --ip <IP>              Raspberry Pi IP adresi
    -p, --password <PASS>      SSH ÅŸifresi

OPSÄ°YONEL PARAMETRELER:
    -u, --user <USER>          SSH kullanÄ±cÄ±sÄ± (varsayÄ±lan: pi)
    --port <PORT>              SSH portu (varsayÄ±lan: 22)
    --repo <URL>               Git repository URL'si
    --branch <BRANCH>          Git branch (varsayÄ±lan: main)
    --skip-system-update       Sistem gÃ¼ncellemesini atla
    --skip-hardware-test       Hardware testini atla
    --dry-run                  Sadece komutlarÄ± gÃ¶ster, Ã§alÄ±ÅŸtÄ±rma
    -v, --verbose              DetaylÄ± Ã§Ä±ktÄ±
    --use-scp                  Proje dosyalarÄ±nÄ± git clone yerine SCP ile kopyala
    -h, --help                 Bu yardÄ±m mesajÄ±nÄ± gÃ¶ster

Ã–RNEKLER:
    # Temel kullanÄ±m
    $SCRIPT_NAME --ip 192.168.1.100 --password mypassword

    # FarklÄ± kullanÄ±cÄ± ile
    $SCRIPT_NAME -i 192.168.1.100 -p mypass -u robot

    # HÄ±zlÄ± kurulum (gÃ¼ncellemeleri atla)
    $SCRIPT_NAME -i 192.168.1.100 -p mypass --skip-system-update

    # Test modu
    $SCRIPT_NAME -i 192.168.1.100 -p mypass --dry-run -v

AÅAMALAR:
    1. ğŸ” Ã–n kontroller (SSH baÄŸlantÄ±sÄ±, iÅŸletim sistemi)
    2. ğŸ“¦ Sistem paketleri kurulumu
    3. ğŸ”§ Raspberry Pi konfigÃ¼rasyonu (I2C, SPI, Camera)
    4. ğŸ“¥ OBA projesi klonlama
    5. ğŸ Python environment kurulumu
    6. âš™ï¸ KonfigÃ¼rasyon ayarlama
    7. ğŸš€ Systemd service kurulumu
    8. ğŸ§ª Validation testleri
    9. ğŸŒ Web interface kontrolÃ¼

NOTLAR:
    â€¢ SSH key ile baÄŸlantÄ± varsa ÅŸifre gerekmez
    â€¢ Script sudo yetkilerini otomatik kullanÄ±r
    â€¢ Hata durumunda rollback yapÄ±lÄ±r
    â€¢ Loglar /tmp/oba-deploy.log'a kaydedilir

HacÄ± Abi'nin emeÄŸi! ğŸ¤–ğŸ’ª
EOF
}

# Parametre parse
parse_arguments() {
    while [[ $# -gt 0 ]]; do
        case $1 in
            -i|--ip)
                PI_IP="$2"
                shift 2
                ;;
            -p|--password)
                PI_PASSWORD="$2"
                shift 2
                ;;
            -u|--user)
                PI_USER="$2"
                shift 2
                ;;
            --port)
                SSH_PORT="$2"
                shift 2
                ;;
            --repo)
                REPO_URL="$2"
                shift 2
                ;;
            --branch)
                BRANCH="$2"
                shift 2
                ;;
            --skip-system-update)
                SKIP_SYSTEM_UPDATE=true
                shift
                ;;
            --skip-hardware-test)
                SKIP_HARDWARE_TEST=true
                shift
                ;;
            --dry-run)
                DRY_RUN=true
                shift
                ;;
            -v|--verbose)
                VERBOSE=true
                shift
                ;;
            --use-scp)
                USE_SCP_COPY=true
                shift
                ;;
            -h|--help)
                show_help
                exit 0
                ;;
            *)
                log_error "Bilinmeyen parametre: $1"
                echo "YardÄ±m iÃ§in: $SCRIPT_NAME --help"
                exit 1
                ;;
        esac
    done

    # Zorunlu parametreleri kontrol et
    if [[ -z "$PI_IP" ]]; then
        log_error "Raspberry Pi IP adresi gerekli!"
        echo "Ã–rnek: $SCRIPT_NAME --ip 192.168.1.100 --password mypassword"
        exit 1
    fi

    if [[ -z "$PI_PASSWORD" ]]; then
        log_warn "Åifre verilmedi. SSH key ile baÄŸlantÄ± denenecek."
    fi

    # Test environment iÃ§in otomatik tespit
    if [[ "$PI_IP" =~ ^172\. ]]; then
        USE_SCP_COPY=true
        log_debug "Test environment tespit edildi (IP: $PI_IP), SCP kopyalama aktifleÅŸtirildi"
    fi
}

# SSH komut Ã§alÄ±ÅŸtÄ±rma fonksiyonu
ssh_exec() {
    local command="$1"
    local show_output="${2:-true}"
    local show_debug="${3:-$show_output}"  # VarsayÄ±lan olarak show_output ile aynÄ±

    if [[ "$show_debug" == "true" ]]; then
        log_debug "SSH Command: $command"
    fi

    if [[ "$DRY_RUN" == "true" ]]; then
        echo -e "${BLUE}[DRY-RUN] SSH: $command${NC}"
        return 0
    fi

    local ssh_cmd="ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no"

    if [[ -n "$PI_PASSWORD" ]]; then
        # sshpass kullan
        if ! command -v sshpass &> /dev/null; then
            log_error "sshpass bulunamadÄ±! Kurulum gerekli: sudo apt install sshpass"
            exit 1
        fi
        ssh_cmd="sshpass -p '$PI_PASSWORD' $ssh_cmd"
    fi

    ssh_cmd="$ssh_cmd -p $SSH_PORT $PI_USER@$PI_IP"

    log_debug "Final SSH command: $ssh_cmd '$command'"

    if [[ "$show_output" == "true" ]]; then
        eval "$ssh_cmd '$command'"
    else
        eval "$ssh_cmd '$command'" 2>/dev/null
    fi
}

# SCP dosya kopyalama
scp_copy() {
    local local_path="$1"
    local remote_path="$2"

    log_debug "SCP: $local_path -> $remote_path"

    if [[ "$DRY_RUN" == "true" ]]; then
        echo -e "${BLUE}[DRY-RUN] SCP: $local_path -> $remote_path${NC}"
        return 0
    fi

    local scp_cmd="scp -o ConnectTimeout=10 -o StrictHostKeyChecking=no -P $SSH_PORT"

    if [[ -n "$PI_PASSWORD" ]]; then
        scp_cmd="sshpass -p '$PI_PASSWORD' $scp_cmd"
    fi

    eval "$scp_cmd '$local_path' $PI_USER@$PI_IP:'$remote_path'"
}

# SSH baÄŸlantÄ±sÄ± test et
test_ssh_connection() {
    log_step "SSH baÄŸlantÄ±sÄ± test ediliyor..."

    if ssh_exec "echo 'SSH baÄŸlantÄ±sÄ± baÅŸarÄ±lÄ±'" false; then
        log_success "SSH baÄŸlantÄ±sÄ± OK"
        return 0
    else
        log_error "SSH baÄŸlantÄ±sÄ± baÅŸarÄ±sÄ±z!"
        log_error "Kontrol edilecekler:"
        log_error "  â€¢ IP adresi doÄŸru mu: $PI_IP"
        log_error "  â€¢ SSH servisi aktif mi"
        log_error "  â€¢ KullanÄ±cÄ± adÄ±/ÅŸifre doÄŸru mu: $PI_USER"
        log_error "  â€¢ Firewall SSH'Ä± blokluyor mu"
        exit 1
    fi
}

# Raspberry Pi sistem kontrolÃ¼
check_raspberry_pi() {
    log_step "Raspberry Pi sistem kontrolÃ¼..."

    # OS kontrolÃ¼
    local os_info
    os_info=$(ssh_exec "cat /etc/os-release | grep PRETTY_NAME" false false) || true

    log_debug "OS Info Ã§Ä±ktÄ±sÄ±: [$os_info]"

    if [[ "$os_info" == *"Raspberry Pi"* ]] || [[ "$os_info" == *"Raspbian"* ]]; then
        log_success "Raspberry Pi OS tespit edildi: $os_info"
    else
        log_warn "Raspberry Pi OS tespit edilemedi. Devam ediliyor..."
        log_debug "Aranan kelimeler: 'Raspberry Pi' veya 'Raspbian'"
    fi

    # Bellek kontrolÃ¼
    log_debug "Bellek kontrolÃ¼ baÅŸlÄ±yor..."
    local memory_mb
    memory_mb=$(ssh_exec 'free -m | awk "NR==2{print \$2}"' false) || memory_mb="0"
    log_debug "Memory MB: [$memory_mb]"

    if [[ -n "$memory_mb" ]] && [[ "$memory_mb" =~ ^[0-9]+$ ]] && [[ "$memory_mb" -lt 3500 ]]; then
        log_warn "DÃ¼ÅŸÃ¼k RAM tespit edildi: ${memory_mb}MB. 4GB Ã¶neriliyor."
    elif [[ -n "$memory_mb" ]] && [[ "$memory_mb" =~ ^[0-9]+$ ]]; then
        log_success "RAM yeterli: ${memory_mb}MB"
    else
        log_warn "RAM bilgisi alÄ±namadÄ±: [$memory_mb]"
    fi

    # Disk alanÄ± kontrolÃ¼
    local disk_available
    disk_available=$(ssh_exec 'df -h / | awk "NR==2 {print \$4}"' false)
    log_info "Mevcut disk alanÄ±: $disk_available"
}

# Sistem paketlerini kur
install_system_packages() {
    if [[ "$SKIP_SYSTEM_UPDATE" == "true" ]]; then
        log_warn "Sistem gÃ¼ncellemesi atlandÄ±"
    else
        log_step "Sistem gÃ¼ncellemesi yapÄ±lÄ±yor..."
        ssh_exec "sudo apt update && sudo apt upgrade -y"
        log_success "Sistem gÃ¼ncellendi"
    fi

    log_step "Gerekli paketler kuruluyor..."

    # Temel paketler
    local packages=(
        "git" "python3" "python3-pip" "python3-venv"
        "i2c-tools"
        "build-essential" "cmake" "pkg-config"
        "libjpeg-dev" "libtiff5-dev" "libpng-dev"
        "libavcodec-dev" "libavformat-dev" "libswscale-dev"
        "libv4l-dev" "libxvidcore-dev" "libx264-dev"
        "libatlas-base-dev" "gfortran"
        "libhdf5-dev" "libhdf5-serial-dev"
        "python3-dev"
    )

    # Raspberry Pi ise raspi-config ekle
    local os_info
    os_info=$(ssh_exec "cat /etc/os-release | grep '^ID='" false false) || true
    local pretty_name
    pretty_name=$(ssh_exec "cat /etc/os-release | grep 'PRETTY_NAME'" false false) || true

    log_debug "OS ID tespit ediliyor: [$os_info]"
    log_debug "Pretty name: [$pretty_name]"

    # Test Environment deÄŸil ve raspbian ise raspi-config ekle
    if [[ "$os_info" == *"raspbian"* ]] && [[ "$pretty_name" != *"Test Environment"* ]]; then
        packages+=("raspi-config")
        log_debug "GerÃ§ek Raspberry Pi tespit edildi, raspi-config eklendi"
    else
        log_debug "Test environment veya non-Raspbian sistem tespit edildi, raspi-config atlandÄ±"
    fi

    local package_list
    package_list=$(IFS=' '; echo "${packages[*]}")

    ssh_exec "sudo apt install -y $package_list"
    log_success "Paketler kuruldu"
}

# Raspberry Pi konfigÃ¼rasyonu
configure_raspberry_pi() {
    log_step "Raspberry Pi konfigÃ¼rasyonu yapÄ±lÄ±yor..."

    # I2C aktifleÅŸtir
    ssh_exec "sudo raspi-config nonint do_i2c 0"
    log_debug "I2C aktifleÅŸtirildi"

    # SPI aktifleÅŸtir
    ssh_exec "sudo raspi-config nonint do_spi 0"
    log_debug "SPI aktifleÅŸtirildi"

    # Kamera aktifleÅŸtir
    ssh_exec "sudo raspi-config nonint do_camera 0"
    log_debug "Kamera aktifleÅŸtirildi"

    # SSH aktif (zaten aktif ama emin olmak iÃ§in)
    ssh_exec "sudo raspi-config nonint do_ssh 0"
    log_debug "SSH aktifleÅŸtirildi"

    # KullanÄ±cÄ± gruplarÄ±
    ssh_exec "sudo usermod -a -G i2c,spi,gpio,video,input $PI_USER"
    log_debug "KullanÄ±cÄ± gruplarÄ± gÃ¼ncellendi"

    log_success "Raspberry Pi konfigÃ¼rasyonu tamamlandÄ±"
}

# OBA projesini klonla ve kur
install_oba_project() {
    log_step "OBA projesi kopyalanÄ±yor..."

    # Varolan oba klasÃ¶rÃ¼nÃ¼ backup'la
    ssh_exec "if [ -d 'oba' ]; then mv oba oba_backup_\$(date +%Y%m%d_%H%M%S); fi"

    if [[ "$USE_SCP_COPY" == "true" ]]; then
        log_info "SCP ile dosya kopyalama baÅŸlatÄ±ldÄ±..."

        local workspace_path="/workspaces/oba"
        local temp_tar="/tmp/oba-project.tar.gz"
        log_debug "PROJECT_ROOT deÄŸeri: [$PROJECT_ROOT]"
        log_debug "Workspace path: [$workspace_path]"
        log_debug "Workspace paketleniyor: $workspace_path -> $temp_tar"

        tar -czf "$temp_tar" \
            -C "$workspace_path" \
            --exclude='.git' \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='temp/*' \
            --exclude='logs/*' \
            --exclude='venv' \
            --exclude='.pytest_cache' \
            --exclude='node_modules' \
            .

        scp_copy "$temp_tar" "/tmp/oba-project.tar.gz"
        ssh_exec "mkdir -p oba"
        ssh_exec "cd oba && tar -xzf /tmp/oba-project.tar.gz"
        ssh_exec "rm -f /tmp/oba-project.tar.gz"
        rm -f "$temp_tar"

        log_success "Proje SCP ile kopyalandÄ±"
    else
        ssh_exec "git clone -b $BRANCH $REPO_URL oba"
        ssh_exec "cd oba && git log --oneline -1"
        log_success "Proje git ile klonlandÄ±"
    fi

    log_step "Python environment kuruluyor..."

    # Virtual environment
    ssh_exec "cd oba && python3 -m venv venv"
    ssh_exec "cd oba && source venv/bin/activate && pip install --upgrade pip setuptools wheel"

    # Dependencies
    ssh_exec "cd oba && source venv/bin/activate && pip install -r requirements.txt"

    # OpenCV (Raspberry Pi Ã¶zel)
    ssh_exec "cd oba && source venv/bin/activate && pip install opencv-python-headless==4.8.1.78"

    log_success "Python environment kuruldu"
}

# KonfigÃ¼rasyon ayarla
configure_oba() {
    log_step "OBA konfigÃ¼rasyonu yapÄ±lÄ±yor..."

    # Production config'i kopyala
    ssh_exec "cd oba && cp config/environments/raspberry_pi.yaml config/robot_config.yaml"

    # Dizinleri oluÅŸtur
    ssh_exec "cd oba && mkdir -p logs temp data/maps data/sensor_data"
    ssh_exec "cd oba && chmod 755 logs temp data"

    # Script'leri PATH'e ekle
    ssh_exec "echo 'export PATH=\"/home/$PI_USER/oba/scripts:\$PATH\"' >> ~/.bashrc"
    ssh_exec "cd oba && chmod +x scripts/*"

    log_success "KonfigÃ¼rasyon tamamlandÄ±"
}

# Systemd service kur
install_systemd_service() {
    log_step "Systemd service kuruluyor..."

    # Service dosyasÄ±nÄ± oluÅŸtur (temp file kullanarak)
    local service_file="/tmp/oba-robot.service"
    cat > "$service_file" << EOF
[Unit]
Description=OBA Autonomous Garden Robot
After=network.target
Wants=network.target

[Service]
Type=simple
User=$PI_USER
Group=$PI_USER
WorkingDirectory=/home/$PI_USER/oba
Environment=PATH=/home/$PI_USER/oba/venv/bin:/home/$PI_USER/oba/scripts:/usr/local/bin:/usr/bin:/bin
ExecStart=/home/$PI_USER/oba/venv/bin/python main.py
ExecStop=/home/$PI_USER/oba/scripts/oba-stop
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF

    # Service dosyasÄ±nÄ± kopyala ve kur
    scp_copy "$service_file" "/tmp/oba-robot.service"
    ssh_exec "sudo mv /tmp/oba-robot.service /etc/systemd/system/"
    rm -f "$service_file"

    # Service'i aktifleÅŸtir
    ssh_exec "sudo systemctl daemon-reload"
    ssh_exec "sudo systemctl enable oba-robot.service"

    log_success "Systemd service kuruldu"
}

# Firewall ayarla
configure_firewall() {
    log_step "Firewall ayarlanÄ±yor..."

    # UFW kur ve ayarla
    ssh_exec "sudo apt install ufw -y"
    ssh_exec "sudo ufw --force reset"
    ssh_exec "sudo ufw default deny incoming"
    ssh_exec "sudo ufw default allow outgoing"
    ssh_exec "sudo ufw allow ssh"
    ssh_exec "sudo ufw allow 8080"
    ssh_exec "sudo ufw --force enable"

    log_success "Firewall ayarlandÄ±"
}

# Hardware testi
test_hardware() {
    if [[ "$SKIP_HARDWARE_TEST" == "true" ]]; then
        log_warn "Hardware testi atlandÄ±"
        return 0
    fi

    log_step "Hardware testi yapÄ±lÄ±yor..."

    # I2C cihazlarÄ±
    ssh_exec "i2cdetect -y 1"

    # Python testleri
    ssh_exec "cd oba && source venv/bin/activate && python -c 'import cv2; print(\"OpenCV version:\", cv2.__version__)'"

    log_success "Hardware testi baÅŸarÄ±lÄ±"
}

# Validation
validate_installation() {
    log_step "Kurulum doÄŸrulanÄ±yor..."

    # Python environment testi
    ssh_exec "cd oba && source venv/bin/activate && python -c 'import src.core.robot; print(\"Robot modÃ¼lÃ¼ yÃ¼klendi\")'"

    # Config testi
    ssh_exec "cd oba && ls -la config/robot_config.yaml"

    # Script'ler testi
    ssh_exec "cd oba && source ~/.bashrc && which oba-help"

    # Service testi
    ssh_exec "sudo systemctl is-enabled oba-robot.service"

    log_success "Validation baÅŸarÄ±lÄ±"
}

# Robot'u baÅŸlat
start_robot() {
    log_step "Robot baÅŸlatÄ±lÄ±yor..."

    # Manuel test iÃ§in baÅŸlat
    ssh_exec "sudo systemctl start oba-robot.service"

    # Biraz bekle
    sleep 5

    # Durum kontrol et
    if ssh_exec "sudo systemctl is-active oba-robot.service" false; then
        log_success "Robot baÅŸarÄ±yla baÅŸlatÄ±ldÄ±"

        # Web interface kontrolÃ¼
        log_step "Web interface kontrol ediliyor..."

        if ssh_exec "curl -s http://localhost:8080 > /dev/null" false; then
            log_success "Web interface eriÅŸilebilir: http://$PI_IP:8080"
        else
            log_warn "Web interface henÃ¼z hazÄ±r deÄŸil, 30 saniye bekleyin"
        fi
    else
        log_error "Robot baÅŸlatÄ±lamadÄ±!"
        ssh_exec "sudo journalctl -u oba-robot.service --no-pager -n 20"
        return 1
    fi
}

# Deployment Ã¶zeti
show_deployment_summary() {
    log_success "ğŸ‰ OBA Robot deployment tamamlandÄ±!"
    echo ""
    echo -e "${CYAN}ğŸ“‹ DEPLOYMENT Ã–ZETÄ°${NC}"
    echo "=================================="
    echo -e "ğŸ“ Raspberry Pi: ${GREEN}$PI_IP${NC}"
    echo -e "ğŸ‘¤ KullanÄ±cÄ±: ${GREEN}$PI_USER${NC}"
    echo -e "ğŸ“‚ Proje Yolu: ${GREEN}/home/$PI_USER/oba${NC}"
    echo -e "ğŸŒ Web Interface: ${GREEN}http://$PI_IP:8080${NC}"
    echo -e "ğŸ”§ Service: ${GREEN}oba-robot.service${NC}"
    echo ""
    echo -e "${CYAN}ğŸ® KULLANIÅLI KOMUTLAR${NC}"
    echo "=================================="
    echo "# SSH ile baÄŸlan"
    echo "ssh $PI_USER@$PI_IP"
    echo ""
    echo "# Robot kontrol"
    echo "sudo systemctl status oba-robot.service"
    echo "sudo systemctl restart oba-robot.service"
    echo "sudo journalctl -u oba-robot.service -f"
    echo ""
    echo "# Script'ler (SSH'dan sonra)"
    echo "oba-status        # Sistem durumu"
    echo "oba-logs follow   # CanlÄ± loglar"
    echo "oba-test         # Test Ã§alÄ±ÅŸtÄ±r"
    echo ""
    echo -e "${GREEN}HacÄ± Abi'nin emeÄŸi! Robot hazÄ±r! ğŸ¤–ğŸ’ª${NC}"
}

# Hata durumunda temizlik
cleanup_on_error() {
    log_error "Deployment sÄ±rasÄ±nda hata oluÅŸtu!"
    log_warn "Temizlik yapÄ±lÄ±yor..."

    # Service'i durdur
    ssh_exec "sudo systemctl stop oba-robot.service || true" false
    ssh_exec "sudo systemctl disable oba-robot.service || true" false

    # Backup'tan geri yÃ¼kle (varsa)
    ssh_exec "if [ -d 'oba_backup_*' ]; then rm -rf oba && mv oba_backup_* oba; fi" false

    log_warn "Partial kurulum temizlendi"
}

# Ana deployment fonksiyonu
main_deployment() {
    local start_time
    start_time=$(date +%s)

    log_info "ğŸš€ OBA Robot Deployment BaÅŸlÄ±yor..."
    log_info "Target: $PI_USER@$PI_IP:$SSH_PORT"
    echo ""

    # Hata durumunda cleanup Ã§alÄ±ÅŸtÄ±r
    trap cleanup_on_error ERR

    # Deployment aÅŸamalarÄ±
    test_ssh_connection
    check_raspberry_pi
    install_system_packages
    configure_raspberry_pi
    install_oba_project
    configure_oba
    install_systemd_service
    configure_firewall
    test_hardware
    validate_installation
    start_robot

    # SÃ¼re hesapla
    local end_time
    end_time=$(date +%s)
    local duration=$((end_time - start_time))

    echo ""
    log_success "Deployment ${duration} saniyede tamamlandÄ±!"
    show_deployment_summary
}

# Ana script
main() {
    # Banner
    echo -e "${CYAN}"
    cat << "EOF"
   ____  ____    _      ____       _           _
  / __ \|  _ \  / \    |  _ \ ___ | |__   ___ | |_
 | |  | | |_) |/ _ \   | |_) / _ \| '_ \ / _ \| __|
 | |__| |  _ </ ___ \  |  _ < (_) | |_) | (_) | |_
  \____/|_| \_\_/   \_\ |_| \_\___/|_.__/ \___/ \__|

      ğŸ¤– Otomatik Raspberry Pi Deployment ğŸ“
           HacÄ± Abi'nin sihirli aracÄ±!
EOF
    echo -e "${NC}"

    # Ã–n kontroller
    if ! command -v ssh &> /dev/null; then
        log_error "SSH client bulunamadÄ±!"
        exit 1
    fi

    # Parametreleri parse et
    parse_arguments "$@"

    # sshpass kontrolÃ¼ (ÅŸifre verilmiÅŸse)
    if [[ -n "$PI_PASSWORD" ]] && ! command -v sshpass &> /dev/null; then
        log_error "sshpass bulunamadÄ±!"
        log_error "Kurulum: sudo apt install sshpass"
        exit 1
    fi

    # Onay al (dry-run deÄŸilse)
    if [[ "$DRY_RUN" != "true" ]]; then
        echo -e "${YELLOW}âš ï¸  $PI_IP adresine deployment yapÄ±lacak. Devam edilsin mi? (y/N)${NC}"
        read -r response
        if [[ ! "$response" =~ ^[Yy]$ ]]; then
            log_info "Deployment iptal edildi"
            exit 0
        fi
    fi

    # Ana deployment
    main_deployment
}

# Script'i Ã§alÄ±ÅŸtÄ±r
main "$@"

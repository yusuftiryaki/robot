#!/bin/bash
# -*- coding: utf-8 -*-
"""
Otonom BahÃ§e AsistanÄ± (OBA) - Log GÃ¶rÃ¼ntÃ¼leme Scripti
===========================================

Bu script log dosyalarÄ±nÄ± farklÄ± modlarda gÃ¶rÃ¼ntÃ¼ler.
"""

# Proje ana dizinine git
cd "$(dirname "$0")/.."

# Renk kodlarÄ±
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Banner
echo -e "${CYAN}"
echo "ğŸ“ ROBOT LOG GÃ–RÃœNTÃœLEYICI"
echo "=========================="
echo -e "${NC}"

# Parametreleri kontrol et
LOG_TYPE="all"
FOLLOW=false
LINES=50

for arg in "$@"; do
    case $arg in
        error|err)
            LOG_TYPE="error"
            echo -e "${BLUE}ğŸš¨ Sadece hatalar gÃ¶sterilecek${NC}"
            ;;
        warning|warn)
            LOG_TYPE="warning"
            echo -e "${BLUE}âš ï¸ Sadece uyarÄ±lar gÃ¶sterilecek${NC}"
            ;;
        debug)
            LOG_TYPE="debug"
            echo -e "${BLUE}ğŸ” Debug loglarÄ± gÃ¶sterilecek${NC}"
            ;;
        battery|bat)
            LOG_TYPE="battery"
            echo -e "${BLUE}ğŸ”‹ Batarya loglarÄ± gÃ¶sterilecek${NC}"
            ;;
        gps)
            LOG_TYPE="gps"
            echo -e "${BLUE}ğŸ“ GPS loglarÄ± gÃ¶sterilecek${NC}"
            ;;
        sensors|sensor)
            LOG_TYPE="sensors"
            echo -e "${BLUE}ğŸ“¡ SensÃ¶r loglarÄ± gÃ¶sterilecek${NC}"
            ;;
        navigation|nav)
            LOG_TYPE="navigation"
            echo -e "${BLUE}ğŸ§­ Navigation loglarÄ± gÃ¶sterilecek${NC}"
            ;;
        web)
            LOG_TYPE="web"
            echo -e "${BLUE}ğŸŒ Web server loglarÄ± gÃ¶sterilecek${NC}"
            ;;
        today)
            LOG_TYPE="today"
            echo -e "${BLUE}ğŸ“… BugÃ¼nkÃ¼ loglar gÃ¶sterilecek${NC}"
            ;;
        follow|f)
            FOLLOW=true
            echo -e "${BLUE}ğŸ‘ï¸ CanlÄ± log takibi aktif${NC}"
            ;;
        help|-h|--help)
            echo "KullanÄ±m: oba-logs [seÃ§enekler]"
            echo ""
            echo "Log Tipleri:"
            echo "  error, err        Sadece hatalar"
            echo "  warning, warn     Sadece uyarÄ±lar"
            echo "  debug             Debug loglarÄ±"
            echo "  battery, bat      Batarya loglarÄ±"
            echo "  gps               GPS loglarÄ±"
            echo "  sensors, sensor   SensÃ¶r loglarÄ±"
            echo "  navigation, nav   Navigation loglarÄ±"
            echo "  web               Web server loglarÄ±"
            echo "  today             BugÃ¼nkÃ¼ loglar"
            echo ""
            echo "SeÃ§enekler:"
            echo "  follow, f         CanlÄ± log takibi"
            echo "  help              Bu yardÄ±mÄ± gÃ¶ster"
            echo ""
            echo "Ã–rnekler:"
            echo "  oba-logs                  TÃ¼m loglarÄ± gÃ¶ster"
            echo "  oba-logs error            Sadece hatalarÄ± gÃ¶ster"
            echo "  oba-logs follow           CanlÄ± log takibi"
            echo "  oba-logs battery follow   Batarya loglarÄ±nÄ± canlÄ± takip"
            exit 0
            ;;
        *)
            # SatÄ±r sayÄ±sÄ± parametresi olup olmadÄ±ÄŸÄ±nÄ± kontrol et
            if [[ "$arg" =~ ^[0-9]+$ ]]; then
                LINES=$arg
                echo -e "${BLUE}ğŸ“ Son $LINES satÄ±r gÃ¶sterilecek${NC}"
            else
                echo -e "${RED}âŒ Bilinmeyen parametre: $arg${NC}"
                echo "YardÄ±m iÃ§in: oba-logs help"
                exit 1
            fi
            ;;
    esac
done

# Log klasÃ¶rÃ¼ kontrolÃ¼
if [[ ! -d "logs" ]]; then
    echo -e "${RED}âŒ Log klasÃ¶rÃ¼ bulunamadÄ±!${NC}"
    echo "Robot hiÃ§ Ã§alÄ±ÅŸtÄ±rÄ±lmamÄ±ÅŸ olabilir."
    echo "BaÅŸlatmak iÃ§in: oba-start"
    exit 1
fi

# Mevcut log dosyalarÄ±nÄ± listele
echo -e "${CYAN}ğŸ“ Mevcut log dosyalarÄ±:${NC}"
ls -la logs/*.log 2>/dev/null | while read -r line; do
    echo "  $line"
done

if [[ $(ls logs/*.log 2>/dev/null | wc -l) -eq 0 ]]; then
    echo -e "${YELLOW}âš ï¸ HiÃ§ log dosyasÄ± bulunamadÄ±${NC}"
    exit 1
fi

echo ""

# YardÄ±mcÄ± fonksiyonlar
show_logs_with_filter() {
    local pattern="$1"
    local files="$2"
    local description="$3"
    
    echo -e "${CYAN}$description${NC}"
    echo "$(printf '=%.0s' {1..40})"
    
    if $FOLLOW; then
        echo "ğŸ“¡ CanlÄ± takip aktif - Ã‡Ä±kmak iÃ§in Ctrl+C"
        echo ""
        tail -f $files | grep --color=always -i "$pattern"
    else
        local result=$(grep -i "$pattern" $files 2>/dev/null | tail -n $LINES)
        if [[ -n "$result" ]]; then
            echo "$result" | while IFS= read -r line; do
                # Renk kodlamasÄ±
                if echo "$line" | grep -qi "error\|exception\|critical"; then
                    echo -e "${RED}$line${NC}"
                elif echo "$line" | grep -qi "warning\|warn"; then
                    echo -e "${YELLOW}$line${NC}"
                elif echo "$line" | grep -qi "debug"; then
                    echo -e "${BLUE}$line${NC}"
                elif echo "$line" | grep -qi "info"; then
                    echo -e "${GREEN}$line${NC}"
                else
                    echo "$line"
                fi
            done
        else
            echo -e "${YELLOW}ğŸ“­ Bu kategoride log bulunamadÄ±${NC}"
        fi
    fi
    echo ""
}

show_all_logs() {
    echo -e "${CYAN}ğŸ“Š TÃœM LOGLAR (Son $LINES satÄ±r)${NC}"
    echo "================================"
    
    if $FOLLOW; then
        echo "ğŸ“¡ CanlÄ± takip aktif - Ã‡Ä±kmak iÃ§in Ctrl+C"
        echo ""
        tail -f logs/*.log 2>/dev/null
    else
        # TÃ¼m log dosyalarÄ±nÄ± zaman sÄ±rasÄ±na gÃ¶re birleÅŸtir
        local all_logs=""
        for log_file in logs/*.log; do
            if [[ -f "$log_file" ]]; then
                all_logs="$all_logs $log_file"
            fi
        done
        
        if [[ -n "$all_logs" ]]; then
            tail -n $LINES $all_logs | sort | while IFS= read -r line; do
                # Renk kodlamasÄ±
                if echo "$line" | grep -qi "error\|exception\|critical"; then
                    echo -e "${RED}$line${NC}"
                elif echo "$line" | grep -qi "warning\|warn"; then
                    echo -e "${YELLOW}$line${NC}"
                elif echo "$line" | grep -qi "debug"; then
                    echo -e "${BLUE}$line${NC}"
                elif echo "$line" | grep -qi "info"; then
                    echo -e "${GREEN}$line${NC}"
                else
                    echo "$line"
                fi
            done
        else
            echo -e "${YELLOW}ğŸ“­ Log dosyasÄ± bulunamadÄ±${NC}"
        fi
    fi
    echo ""
}

show_today_logs() {
    local today=$(date +%Y-%m-%d)
    echo -e "${CYAN}ğŸ“… BUGÃœNKÃœ LOGLAR ($today)${NC}"
    echo "================================="
    
    local today_logs=""
    for log_file in logs/*.log; do
        if [[ -f "$log_file" ]]; then
            local file_date=$(date -r "$log_file" +%Y-%m-%d 2>/dev/null)
            if [[ "$file_date" == "$today" ]]; then
                today_logs="$today_logs $log_file"
            fi
        fi
    done
    
    if [[ -n "$today_logs" ]]; then
        if $FOLLOW; then
            echo "ğŸ“¡ CanlÄ± takip aktif - Ã‡Ä±kmak iÃ§in Ctrl+C"
            echo ""
            tail -f $today_logs
        else
            cat $today_logs | tail -n $LINES | while IFS= read -r line; do
                # Renk kodlamasÄ±
                if echo "$line" | grep -qi "error\|exception\|critical"; then
                    echo -e "${RED}$line${NC}"
                elif echo "$line" | grep -qi "warning\|warn"; then
                    echo -e "${YELLOW}$line${NC}"
                elif echo "$line" | grep -qi "debug"; then
                    echo -e "${BLUE}$line${NC}"
                elif echo "$line" | grep -qi "info"; then
                    echo -e "${GREEN}$line${NC}"
                else
                    echo "$line"
                fi
            done
        fi
    else
        echo -e "${YELLOW}ğŸ“­ BugÃ¼n oluÅŸturulan log bulunamadÄ±${NC}"
    fi
    echo ""
}

# Ana kontrol akÄ±ÅŸÄ±
case $LOG_TYPE in
    "all")
        show_all_logs
        ;;
    "error")
        show_logs_with_filter "error\|exception\|critical" "logs/*.log" "ğŸš¨ HATA LOGLARI"
        ;;
    "warning")
        show_logs_with_filter "warning\|warn" "logs/*.log" "âš ï¸ UYARI LOGLARI"
        ;;
    "debug")
        show_logs_with_filter "debug" "logs/*.log" "ğŸ” DEBUG LOGLARI"
        ;;
    "battery")
        if [[ -f "logs/battery.log" ]]; then
            show_logs_with_filter ".*" "logs/battery.log" "ğŸ”‹ BATARYA LOGLARI"
        else
            echo -e "${YELLOW}ğŸ“­ Batarya log dosyasÄ± bulunamadÄ±${NC}"
        fi
        ;;
    "gps")
        if [[ -f "logs/gps.log" ]]; then
            show_logs_with_filter ".*" "logs/gps.log" "ğŸ“ GPS LOGLARI"
        else
            echo -e "${YELLOW}ğŸ“­ GPS log dosyasÄ± bulunamadÄ±${NC}"
        fi
        ;;
    "sensors")
        if [[ -f "logs/sensors.log" ]]; then
            show_logs_with_filter ".*" "logs/sensors.log" "ğŸ“¡ SENSÃ–R LOGLARI"
        else
            echo -e "${YELLOW}ğŸ“­ SensÃ¶r log dosyasÄ± bulunamadÄ±${NC}"
        fi
        ;;
    "navigation")
        if [[ -f "logs/navigation.log" ]]; then
            show_logs_with_filter ".*" "logs/navigation.log" "ğŸ§­ NAVÄ°GASYON LOGLARI"
        else
            echo -e "${YELLOW}ğŸ“­ Navigation log dosyasÄ± bulunamadÄ±${NC}"
        fi
        ;;
    "web")
        if [[ -f "logs/web.log" ]]; then
            show_logs_with_filter ".*" "logs/web.log" "ğŸŒ WEB SERVER LOGLARI"
        else
            echo -e "${YELLOW}ğŸ“­ Web server log dosyasÄ± bulunamadÄ±${NC}"
        fi
        ;;
    "today")
        show_today_logs
        ;;
esac

# Ä°statistikler
if [[ ! $FOLLOW ]]; then
    echo -e "${CYAN}ğŸ“Š LOG Ä°STATÄ°STÄ°KLERÄ°${NC}"
    echo "===================="
    
    # Toplam log sayÄ±sÄ±
    local total_lines=$(cat logs/*.log 2>/dev/null | wc -l)
    echo "ğŸ“ Toplam log satÄ±rÄ±: $total_lines"
    
    # Hata sayÄ±sÄ±
    local error_count=$(grep -i "error\|exception\|critical" logs/*.log 2>/dev/null | wc -l)
    echo "ğŸš¨ Toplam hata sayÄ±sÄ±: $error_count"
    
    # UyarÄ± sayÄ±sÄ±
    local warning_count=$(grep -i "warning\|warn" logs/*.log 2>/dev/null | wc -l)
    echo "âš ï¸ Toplam uyarÄ± sayÄ±sÄ±: $warning_count"
    
    # En bÃ¼yÃ¼k log dosyasÄ±
    local largest_log=$(ls -lS logs/*.log 2>/dev/null | head -1 | awk '{print $9, $5}')
    if [[ -n "$largest_log" ]]; then
        echo "ğŸ“ En bÃ¼yÃ¼k log: $largest_log bytes"
    fi
    
    echo ""
    
    # YararlÄ± komutlar
    echo -e "${CYAN}ğŸ’¡ YARALI KOMUTLAR:${NC}"
    echo "  oba-logs follow           CanlÄ± log takibi"
    echo "  oba-logs error            Sadece hatalarÄ± gÃ¶ster"
    echo "  oba-logs 100              Son 100 satÄ±rÄ± gÃ¶ster"
    echo "  oba-clean logs            Eski loglarÄ± temizle"
fi

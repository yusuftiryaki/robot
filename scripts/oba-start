#!/bin/bash
# OBA Robot GeliÅŸtirilmiÅŸ BaÅŸlatma Scripti

set -e

# Renkli Ã§Ä±ktÄ±
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# Banner
echo -e "${CYAN}"
echo "  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— "
echo " â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—"
echo " â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘"
echo " â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘"
echo " â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆ    # AdÄ±mlarÄ± Ã§alÄ±ÅŸtÄ±r
    check_requirements
    check_system_dependencies
    create_directories
    check_config_files
    setup_virtual_environment
    install_packages
    test_environment          # ğŸ†• Ortam testi eklendi
    check_robot_status"  â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•"
echo -e "${NC}"
echo -e "${GREEN}ğŸ¤– HacÄ± Abi'nin OBA Robot'u BaÅŸlatÄ±lÄ±yor...${NC}"
echo "=================================================="

# Parametreler
SIMULATION_MODE=false
DEBUG_MODE=false
HELP_MODE=false

# Parametre parsing
while [[ $# -gt 0 ]]; do
    case $1 in
        --sim|--simulation)
            SIMULATION_MODE=true
            shift
            ;;
        --debug|-d)
            DEBUG_MODE=true
            shift
            ;;
        --help|-h)
            HELP_MODE=true
            shift
            ;;
        *)
            echo -e "${YELLOW}âš ï¸ Bilinmeyen parametre: $1${NC}"
            shift
            ;;
    esac
done

# YardÄ±m gÃ¶ster
if [ "$HELP_MODE" = true ]; then
    echo -e "${BLUE}ğŸ“– OBA Robot KullanÄ±mÄ±:${NC}"
    echo "  oba-start [seÃ§enekler]"
    echo ""
    echo "SeÃ§enekler:"
    echo "  --sim, --simulation    SimÃ¼lasyon modunda baÅŸlat"
    echo "  --debug, -d           Debug modunda baÅŸlat"
    echo "  --help, -h            Bu yardÄ±m mesajÄ±nÄ± gÃ¶ster"
    echo ""
    echo "Ã–rnekler:"
    echo "  oba-start              Normal mod"
    echo "  oba-start --sim        SimÃ¼lasyon modu"
    echo "  oba-start --debug      Debug modu"
    echo "  oba-start --sim -d     SimÃ¼lasyon + Debug"
    exit 0
fi

# Sistem gereksinimleri kontrol et
check_requirements() {
    echo -e "${BLUE}ğŸ” Sistem gereksinimleri kontrol ediliyor...${NC}"

    # Python kontrolÃ¼
    if ! command -v python3 &> /dev/null; then
        echo -e "${RED}âŒ Python3 bulunamadÄ±!${NC}"
        exit 1
    fi

    PYTHON_VERSION=$(python3 --version | cut -d' ' -f2)
    echo -e "${GREEN}âœ… Python: $PYTHON_VERSION${NC}"

    # pip kontrolÃ¼
    if ! command -v pip3 &> /dev/null; then
        echo -e "${RED}âŒ pip3 bulunamadÄ±!${NC}"
        exit 1
    fi

    # Git kontrolÃ¼
    if ! command -v git &> /dev/null; then
        echo -e "${YELLOW}âš ï¸ Git bulunamadÄ± (isteÄŸe baÄŸlÄ±)${NC}"
    else
        echo -e "${GREEN}âœ… Git mevcut${NC}"
    fi

    # Disk alanÄ± kontrolÃ¼
    AVAILABLE_SPACE=$(df . | tail -1 | awk '{print $4}')
    if [ "$AVAILABLE_SPACE" -lt 1000000 ]; then  # 1GB
        echo -e "${YELLOW}âš ï¸ Disk alanÄ± azalÄ±yor: $(df -h . | tail -1 | awk '{print $4}')${NC}"
    fi
}

# Sistem baÄŸÄ±mlÄ±lÄ±klarÄ±nÄ± kontrol et ve kur
check_system_dependencies() {
    echo -e "${BLUE}ğŸ”§ Sistem baÄŸÄ±mlÄ±lÄ±klarÄ± kontrol ediliyor...${NC}"

    # Gerekli sistem paketleri
    REQUIRED_PACKAGES=(
        "build-essential"
        "python3-dev"
        "python3-venv"
        "libcap-dev"
        "libffi-dev"
        "libssl-dev"
        "libjpeg-dev"
        "libpng-dev"
        "libavformat-dev"
        "libavcodec-dev"
        "libavdevice-dev"
        "libavutil-dev"
        "libswscale-dev"
        "libswresample-dev"
        "libavfilter-dev"
        "pkg-config"
    )

    MISSING_PACKAGES=()

    # Eksik paketleri kontrol et
    for package in "${REQUIRED_PACKAGES[@]}"; do
        if ! dpkg -l | grep -q "^ii  $package "; then
            MISSING_PACKAGES+=("$package")
        fi
    done

    # Eksik paketler varsa kur
    if [ ${#MISSING_PACKAGES[@]} -gt 0 ]; then
        echo -e "${YELLOW}âš ï¸ Eksik sistem paketleri: ${MISSING_PACKAGES[*]}${NC}"

        # Sudo kontrolÃ¼
        if [ "$EUID" -ne 0 ]; then
            echo -e "${BLUE}ğŸ” Sistem paketleri kurmak iÃ§in sudo yetkisi gerekli${NC}"

            # KullanÄ±cÄ± onayÄ± al
            read -p "Eksik paketleri kurmak istiyor musunuz? (y/n): " -n 1 -r
            echo

            if [[ $REPLY =~ ^[Yy]$ ]]; then
                echo -e "${BLUE}ğŸ“¦ Eksik paketler kuruluyor...${NC}"

                # Paket listesini gÃ¼ncelle
                sudo apt update || {
                    echo -e "${YELLOW}âš ï¸ apt update baÅŸarÄ±sÄ±z, devam ediliyor...${NC}"
                }

                # Paketleri kur
                sudo apt install -y "${MISSING_PACKAGES[@]}" || {
                    echo -e "${RED}âŒ BazÄ± sistem paketleri kurulamadÄ±!${NC}"
                    echo -e "${YELLOW}ğŸ’¡ Manuel olarak kurmayÄ± deneyin:${NC}"
                    echo "sudo apt install -y ${MISSING_PACKAGES[*]}"
                    exit 1
                }

                echo -e "${GREEN}âœ… Sistem paketleri kuruldu${NC}"
            else
                echo -e "${RED}âŒ Sistem paketleri olmadan robot Ã§alÄ±ÅŸmayabilir!${NC}"
                echo -e "${YELLOW}ğŸ’¡ Manuel kurulum:${NC}"
                echo "sudo apt install -y ${MISSING_PACKAGES[*]}"

                # Devam etmek istiyor mu?
                read -p "Yine de devam etmek istiyor musunuz? (y/n): " -n 1 -r
                echo

                if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                    echo -e "${YELLOW}ğŸ‘‹ Ä°ptal edildi${NC}"
                    exit 0
                fi
            fi
        else
            # Root ise direkt kur
            echo -e "${BLUE}ğŸ“¦ Eksik paketler kuruluyor...${NC}"
            apt update && apt install -y "${MISSING_PACKAGES[@]}"
        fi
    else
        echo -e "${GREEN}âœ… TÃ¼m sistem baÄŸÄ±mlÄ±lÄ±klarÄ± mevcut${NC}"
    fi
}

# Gerekli dizinleri oluÅŸtur
create_directories() {
    echo -e "${BLUE}ğŸ“ Dizinler kontrol ediliyor...${NC}"

    REQUIRED_DIRS=("logs" "data" "config" "models" "data/maps" "data/sensor_data")

    for dir in "${REQUIRED_DIRS[@]}"; do
        if [ ! -d "$dir" ]; then
            echo -e "${YELLOW}ğŸ“ $dir dizini oluÅŸturuluyor...${NC}"
            mkdir -p "$dir"
        fi
    done

    echo -e "${GREEN}âœ… Dizinler hazÄ±r${NC}"
}

# Config dosyalarÄ±nÄ± kontrol et
check_config_files() {
    echo -e "${BLUE}âš™ï¸ KonfigÃ¼rasyon dosyalarÄ± kontrol ediliyor...${NC}"

    # Ana config dosyasÄ±
    if [ ! -f "config/robot_config.yaml" ]; then
        echo -e "${YELLOW}ğŸ“„ VarsayÄ±lan config dosyasÄ± oluÅŸturuluyor...${NC}"
        cp "config/robot_config.yaml.example" "config/robot_config.yaml" 2>/dev/null || {
            echo -e "${RED}âŒ VarsayÄ±lan config dosyasÄ± bulunamadÄ±!${NC}"
            echo -e "${YELLOW}ğŸ’¡ config/robot_config.yaml.example dosyasÄ±nÄ± oluÅŸturun${NC}"
            exit 1
        }
    fi

    # Log config
    if [ ! -f "config/logging.yaml" ]; then
        echo -e "${YELLOW}ğŸ“„ VarsayÄ±lan log config oluÅŸturuluyor...${NC}"
        cp "config/logging.yaml.example" "config/logging.yaml" 2>/dev/null || {
            echo -e "${YELLOW}âš ï¸ Log config bulunamadÄ±, varsayÄ±lan kullanÄ±lacak${NC}"
        }
    fi

    echo -e "${GREEN}âœ… Config dosyalarÄ± hazÄ±r${NC}"
}

# Virtual environment setup
setup_virtual_environment() {
    echo -e "${BLUE}ğŸ Python virtual environment kontrol ediliyor...${NC}"

    if [ ! -d "venv" ]; then
        echo -e "${YELLOW}ğŸ Virtual environment oluÅŸturuluyor...${NC}"
        python3 -m venv venv || {
            echo -e "${RED}âŒ Virtual environment oluÅŸturulamadÄ±!${NC}"
            echo -e "${YELLOW}ğŸ’¡ python3-venv paketini kurun: sudo apt install python3-venv${NC}"
            exit 1
        }
    fi

    # Activate
    source venv/bin/activate

    # Pip upgrade
    echo -e "${BLUE}ğŸ“¦ pip gÃ¼ncelleniyor...${NC}"
    pip install --upgrade pip --quiet || {
        echo -e "${YELLOW}âš ï¸ pip gÃ¼ncellenemedi, devam ediliyor...${NC}"
    }

    echo -e "${GREEN}âœ… Virtual environment hazÄ±r${NC}"
}

# Paket kurulumu
install_packages() {
    echo -e "${BLUE}ğŸ“¦ Python paketleri kontrol ediliyor...${NC}"

    if [ ! -f "requirements.txt" ]; then
        echo -e "${RED}âŒ requirements.txt bulunamadÄ±!${NC}"
        exit 1
    fi

    echo -e "${BLUE}ğŸ“¦ Gerekli paketler kuruluyor...${NC}"

    # Ã–nce wheel kurulumu
    pip install wheel --quiet || {
        echo -e "${YELLOW}âš ï¸ wheel kurulamadÄ±, devam ediliyor...${NC}"
    }

    # Ana paketleri kur
    pip install -r requirements.txt --verbose || {
        echo -e "${RED}âŒ Paket kurulumu baÅŸarÄ±sÄ±z!${NC}"
        echo -e "${YELLOW}ğŸ’¡ Ã‡Ã¶zÃ¼m Ã¶nerileri:${NC}"
        echo "  1. sudo apt install -y libcap-dev build-essential python3-dev"
        echo "  2. pip install --upgrade pip"
        echo "  3. pip install -r requirements.txt --no-cache-dir"
        echo "  4. pip install -r requirements.txt --no-binary :all:"
        echo ""
        echo -e "${BLUE}ğŸ”§ DetaylÄ± hata iÃ§in:${NC}"
        echo "  pip install -r requirements.txt --verbose"

        # Otomatik dÃ¼zeltme dene
        echo -e "${YELLOW}âš ï¸ Otomatik dÃ¼zeltme deneniyor...${NC}"

        # Cache temizle ve tekrar dene
        pip cache purge 2>/dev/null || true
        pip install -r requirements.txt --no-cache-dir --quiet || {
            echo -e "${RED}âŒ Otomatik dÃ¼zeltme de baÅŸarÄ±sÄ±z!${NC}"
            echo -e "${YELLOW}ğŸ’¡ Manuel olarak ÅŸu komutu Ã§alÄ±ÅŸtÄ±rÄ±n:${NC}"
            echo "sudo apt install -y libcap-dev build-essential python3-dev"
            echo "pip install -r requirements.txt"
            exit 1
        }
    }

    echo -e "${GREEN}âœ… Paketler hazÄ±r${NC}"
}

# Robot durumu kontrol et
check_robot_status() {
    echo -e "${BLUE}ğŸ¤– Robot durumu kontrol ediliyor...${NC}"

    # Ã–nceki Ã§alÄ±ÅŸan instance var mÄ±?
    if [ -f "logs/robot.pid" ]; then
        OLD_PID=$(cat logs/robot.pid)
        if ps -p "$OLD_PID" > /dev/null 2>&1; then
            echo -e "${YELLOW}âš ï¸ Robot zaten Ã§alÄ±ÅŸÄ±yor! PID: $OLD_PID${NC}"
            read -p "Yeniden baÅŸlatmak istiyor musunuz? (y/n): " -n 1 -r
            echo
            if [[ $REPLY =~ ^[Yy]$ ]]; then
                echo -e "${BLUE}ğŸ”„ Mevcut robot durduruluyor...${NC}"
                kill "$OLD_PID" 2>/dev/null || true
                sleep 2
            else
                echo -e "${GREEN}ğŸ‘‹ Ä°ptal edildi${NC}"
                exit 0
            fi
        else
            # Eski PID dosyasÄ±nÄ± temizle
            rm -f logs/robot.pid
        fi
    fi

    echo -e "${GREEN}âœ… Robot durumu uygun${NC}"
}

# Ortam tespiti ve test
test_environment() {
    echo -e "${BLUE}ğŸ§ª Ortam uyumluluÄŸu test ediliyor...${NC}"

    # Environment test script'i Ã§alÄ±ÅŸtÄ±r
    python3 test_environment.py --quiet || {
        echo -e "${YELLOW}âš ï¸ Ortam testleri baÅŸarÄ±sÄ±z, devam etmek istiyor musunuz?${NC}"
        read -p "(y/n): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo -e "${GREEN}ğŸ‘‹ Ä°ptal edildi${NC}"
            exit 0
        fi
    }

    echo -e "${GREEN}âœ… Ortam uyumlu${NC}"
}

# Ana program baÅŸlat
start_robot() {
    echo -e "${GREEN}ğŸš€ OBA Robot baÅŸlatÄ±lÄ±yor...${NC}"

    # Parametreleri hazÄ±rla
    ARGS=()

    if [ "$SIMULATION_MODE" = true ]; then
        ARGS+=("--simulation")
        echo -e "${CYAN}ğŸ® SimÃ¼lasyon modu aktif${NC}"
    fi

    if [ "$DEBUG_MODE" = true ]; then
        ARGS+=("--debug")
        echo -e "${CYAN}ğŸ› Debug modu aktif${NC}"
    fi

    echo -e "${BLUE}âš¡ BaÅŸlatma parametreleri: ${ARGS[*]}${NC}"
    echo "=================================================="

    # Ana programÄ± Ã§alÄ±ÅŸtÄ±r
    python3 main.py "${ARGS[@]}" || {
        echo -e "${RED}âŒ Robot baÅŸlatma baÅŸarÄ±sÄ±z!${NC}"
        echo -e "${YELLOW}ğŸ’¡ Log dosyasÄ±nÄ± kontrol edin: logs/robot.log${NC}"
        exit 1
    }
}

# Ana fonksiyon
main() {
    # BaÅŸlangÄ±Ã§ zamanÄ±
    START_TIME=$(date +%s)

    # AdÄ±mlarÄ± Ã§alÄ±ÅŸtÄ±r
    check_requirements
    check_system_dependencies  # ğŸ†• Yeni eklenen
    create_directories
    check_config_files
    setup_virtual_environment
    install_packages
    check_robot_status
    test_environment

    # HazÄ±rlÄ±k sÃ¼resi
    END_TIME=$(date +%s)
    PREP_TIME=$((END_TIME - START_TIME))

    echo -e "${GREEN}âœ… HazÄ±rlÄ±k tamamlandÄ±! ($PREP_TIME saniye)${NC}"
    echo ""

    # Robot'u baÅŸlat
    start_robot
}

# Ctrl+C ile temiz Ã§Ä±kÄ±ÅŸ
trap 'echo -e "\n${YELLOW}ğŸ‘‹ OBA Robot kapatÄ±lÄ±yor...${NC}"; exit 0' INT

# Ana fonksiyonu Ã§alÄ±ÅŸtÄ±r
main "$@"

#!/bin/bash
# -*- coding: utf-8 -*-
#
# Otonom BahÃ§e AsistanÄ± (OBA) - Durum Kontrol Scripti
# =========================================
#
# Bu script robotun mevcut durumunu kontrol eder.
#

# Proje ana dizinine git
cd "$(dirname "$0")/.."

# Ortam tespiti
IS_DEV_CONTAINER=false
IS_SIMULATION=false

# Python environment manager ile ortam tespit et
ENV_INFO=$(python3 -c "
import sys
sys.path.insert(0, 'src')
try:
    from core.environment_manager import EnvironmentManager
    env = EnvironmentManager()
    print('DEV_CONTAINER' if env.is_dev_container() else 'OTHER')
    print('SIMULATION' if env.is_simulation_mode else 'HARDWARE')
except Exception as e:
    print('OTHER')
    print('UNKNOWN')
" 2>/dev/null)

# SonuÃ§larÄ± parse et
if [[ -n "$ENV_INFO" ]]; then
    env_type=$(echo "$ENV_INFO" | head -1)
    sim_mode=$(echo "$ENV_INFO" | tail -1)

    if [[ "$env_type" == "DEV_CONTAINER" ]]; then
        IS_DEV_CONTAINER=true
    fi

    if [[ "$sim_mode" == "SIMULATION" ]]; then
        IS_SIMULATION=true
    fi
fi

# Renk kodlarÄ±
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Banner
echo -e "${CYAN}"
echo "ğŸ“Š ROBOT DURUM KONTROL"
echo "======================"
echo -e "${NC}"

# Parametreyi kontrol et
CHECK_TYPE="all"

for arg in "$@"; do
    case $arg in
        battery|bat)
            CHECK_TYPE="battery"
            echo -e "${BLUE}ğŸ”‹ Batarya durumu kontrol edilecek${NC}"
            ;;
        gps)
            CHECK_TYPE="gps"
            echo -e "${BLUE}ğŸ“ GPS durumu kontrol edilecek${NC}"
            ;;
        sensors|sensor)
            CHECK_TYPE="sensors"
            echo -e "${BLUE}ğŸ“¡ SensÃ¶r durumu kontrol edilecek${NC}"
            ;;
        network|net)
            CHECK_TYPE="network"
            echo -e "${BLUE}ğŸŒ AÄŸ durumu kontrol edilecek${NC}"
            ;;
        system|sys)
            CHECK_TYPE="system"
            echo -e "${BLUE}âš™ï¸ Sistem durumu kontrol edilecek${NC}"
            ;;
        logs)
            CHECK_TYPE="logs"
            echo -e "${BLUE}ğŸ“ Log durumu kontrol edilecek${NC}"
            ;;
        help|-h|--help)
            echo "KullanÄ±m: oba-status [kontrol tipi]"
            echo ""
            echo "Kontrol Tipleri:"
            echo "  battery, bat      Batarya durumu"
            echo "  gps               GPS durumu"
            echo "  sensors, sensor   SensÃ¶r durumu"
            echo "  network, net      AÄŸ durumu"
            echo "  system, sys       Sistem durumu"
            echo "  logs              Log durumu"
            echo "  help              Bu yardÄ±mÄ± gÃ¶ster"
            echo ""
            echo "Ã–rnekler:"
            echo "  oba-status            Genel durum"
            echo "  oba-status battery    Sadece batarya"
            echo "  oba-status gps        Sadece GPS"
            exit 0
            ;;
        *)
            echo -e "${RED}âŒ Bilinmeyen parametre: $arg${NC}"
            echo "YardÄ±m iÃ§in: oba-status help"
            exit 1
            ;;
    esac
done

# YardÄ±mcÄ± fonksiyonlar
check_service_status() {
    local service_name=$1
    if systemctl is-active --quiet "$service_name" 2>/dev/null; then
        echo -e "${GREEN}âœ… $service_name aktif${NC}"
        return 0
    else
        echo -e "${RED}âŒ $service_name aktif deÄŸil${NC}"
        return 1
    fi
}

check_file_age() {
    local file_path=$1
    local max_age_minutes=$2
    local description=$3

    if [[ -f "$file_path" ]]; then
        local file_age_minutes=$(( ($(date +%s) - $(stat -c %Y "$file_path")) / 60 ))
        if [[ $file_age_minutes -le $max_age_minutes ]]; then
            echo -e "${GREEN}âœ… $description gÃ¼ncel (${file_age_minutes} dk Ã¶nce)${NC}"
            return 0
        else
            echo -e "${YELLOW}âš ï¸ $description eski (${file_age_minutes} dk Ã¶nce)${NC}"
            return 1
        fi
    else
        echo -e "${RED}âŒ $description dosyasÄ± bulunamadÄ±${NC}"
        return 1
    fi
}

get_file_size() {
    local file_path=$1
    if [[ -f "$file_path" ]]; then
        du -h "$file_path" | cut -f1
    else
        echo "N/A"
    fi
}

# Ana durum kontrol fonksiyonu
check_general_status() {
    echo -e "${CYAN}ğŸ¤– GENEL ROBOT DURUMU${NC}"
    echo "========================"

    # Python process kontrolÃ¼
    if pgrep -f "main.py" > /dev/null; then
        local pid=$(pgrep -f "main.py")
        local runtime=$(ps -p $pid -o etime= | tr -d ' ')
        echo -e "${GREEN}âœ… Robot aktif (PID: $pid, SÃ¼re: $runtime)${NC}"
    else
        echo -e "${RED}âŒ Robot Ã§alÄ±ÅŸmÄ±yor${NC}"
    fi

    # Web server kontrolÃ¼
    if curl -s http://localhost:5000 > /dev/null 2>&1; then
        echo -e "${GREEN}âœ… Web arayÃ¼zÃ¼ eriÅŸilebilir${NC}"
    else
        echo -e "${YELLOW}âš ï¸ Web arayÃ¼zÃ¼ eriÅŸilemiyor${NC}"
    fi

    # Son aktivite kontrolÃ¼
    check_file_age "logs/robot.log" 5 "Robot aktivitesi"

    echo ""
}

check_battery_status() {
    echo -e "${CYAN}ğŸ”‹ BATARYA DURUMU${NC}"
    echo "=================="

    # Dev container ortamÄ±nda aÃ§Ä±klama
    if $IS_DEV_CONTAINER; then
        echo -e "${BLUE}â„¹ï¸ Dev Container ortamÄ±nda batarya simÃ¼lasyonu kullanÄ±lÄ±yor${NC}"
    fi

    # Batarya log dosyasÄ±nÄ± kontrol et
    local battery_log="logs/battery.log"
    if [[ -f "$battery_log" ]]; then
        local last_battery_line=$(tail -1 "$battery_log" 2>/dev/null)
        if [[ -n "$last_battery_line" ]]; then
            echo "ğŸ“Š Son batarya verisi: $last_battery_line"
        fi
        check_file_age "$battery_log" 10 "Batarya verisi"
    else
        if $IS_DEV_CONTAINER; then
            echo -e "${BLUE}ğŸ® Batarya log dosyasÄ± simÃ¼lasyonda oluÅŸturulacak${NC}"
        else
            echo -e "${YELLOW}âš ï¸ Batarya log dosyasÄ± bulunamadÄ±${NC}"
        fi
    fi

    # Raspberry Pi gÃ¼Ã§ durumu (varsa)
    if [[ -f "/sys/class/power_supply/BAT0/capacity" ]]; then
        local capacity=$(cat /sys/class/power_supply/BAT0/capacity)
        if [[ $capacity -gt 80 ]]; then
            echo -e "${GREEN}âœ… Sistem bataryasÄ±: %$capacity${NC}"
        elif [[ $capacity -gt 20 ]]; then
            echo -e "${YELLOW}âš ï¸ Sistem bataryasÄ±: %$capacity${NC}"
        else
            echo -e "${RED}âŒ Sistem bataryasÄ± dÃ¼ÅŸÃ¼k: %$capacity${NC}"
        fi
    fi

    # INA219 sensÃ¶r verisi (config'den kontrol)
    if grep -q "ina219" config/robot_config.yaml 2>/dev/null; then
        echo "ğŸ”Œ INA219 sensÃ¶rÃ¼ yapÄ±landÄ±rÄ±lmÄ±ÅŸ"
    fi

    echo ""
}

check_gps_status() {
    echo -e "${CYAN}ğŸ“ GPS DURUMU${NC}"
    echo "=============="

    # Dev container ortamÄ±nda aÃ§Ä±klama
    if $IS_DEV_CONTAINER; then
        echo -e "${BLUE}â„¹ï¸ Dev Container ortamÄ±nda GPS simÃ¼lasyonu kullanÄ±lÄ±yor${NC}"
    fi

    # GPS device kontrolÃ¼
    if [[ -c "/dev/ttyAMA0" ]]; then
        echo -e "${GREEN}âœ… GPS cihazÄ± mevcut (/dev/ttyAMA0)${NC}"
    elif [[ -c "/dev/ttyS0" ]]; then
        echo -e "${GREEN}âœ… GPS cihazÄ± mevcut (/dev/ttyS0)${NC}"
    else
        if $IS_DEV_CONTAINER; then
            echo -e "${BLUE}ğŸ® GPS cihazÄ± simÃ¼lasyonda (normal)${NC}"
        else
            echo -e "${YELLOW}âš ï¸ GPS cihazÄ± bulunamadÄ±${NC}"
        fi
    fi

    # GPS log dosyasÄ±nÄ± kontrol et
    local gps_log="logs/gps.log"
    if [[ -f "$gps_log" ]]; then
        local last_gps_line=$(tail -1 "$gps_log" 2>/dev/null)
        if [[ -n "$last_gps_line" ]]; then
            echo "ğŸ“Š Son GPS verisi: $last_gps_line"
        fi
        check_file_age "$gps_log" 30 "GPS verisi"
    else
        if $IS_DEV_CONTAINER; then
            echo -e "${BLUE}ğŸ® GPS log dosyasÄ± simÃ¼lasyonda oluÅŸturulacak${NC}"
        else
            echo -e "${YELLOW}âš ï¸ GPS log dosyasÄ± bulunamadÄ±${NC}"
        fi
    fi

    # GPS fix durumu simulation'dan
    if [[ -f "logs/navigation.log" ]]; then
        local gps_fix=$(grep -i "gps.*fix" logs/navigation.log | tail -1)
        if [[ -n "$gps_fix" ]]; then
            echo "ğŸ›°ï¸ GPS Fix: $gps_fix"
        fi
    fi

    echo ""
}

check_sensors_status() {
    echo -e "${CYAN}ğŸ“¡ SENSÃ–R DURUMU${NC}"
    echo "================="

    # Dev container ortamÄ±nda aÃ§Ä±klama
    if $IS_DEV_CONTAINER; then
        echo -e "${BLUE}â„¹ï¸ Dev Container ortamÄ±nda sensÃ¶r simÃ¼lasyonu kullanÄ±lÄ±yor${NC}"
    fi

    # I2C cihazlarÄ± kontrol et
    if command -v i2cdetect &> /dev/null; then
        echo "ğŸ” I2C cihazlarÄ± taranÄ±yor..."
        local i2c_devices=$(i2cdetect -y 1 2>/dev/null | grep -E '[0-9a-f]{2}' | wc -l)
        if [[ $i2c_devices -gt 0 ]]; then
            echo -e "${GREEN}âœ… $i2c_devices I2C cihazÄ± bulundu${NC}"
        else
            if $IS_DEV_CONTAINER; then
                echo -e "${BLUE}ğŸ® I2C cihazlarÄ± simÃ¼lasyonda (normal)${NC}"
            else
                echo -e "${YELLOW}âš ï¸ I2C cihazÄ± bulunamadÄ±${NC}"
            fi
        fi
    else
        if $IS_DEV_CONTAINER; then
            echo -e "${BLUE}ğŸ® I2C araÃ§larÄ± simÃ¼lasyonda yok (normal)${NC}"
        else
            echo -e "${YELLOW}âš ï¸ I2C araÃ§larÄ± yÃ¼klÃ¼ deÄŸil${NC}"
        fi
    fi

    # GPIO durumu
    if command -v gpio &> /dev/null; then
        echo "ğŸ”Œ GPIO durumu kontrol ediliyor..."
        # Kritik GPIO pinlerini kontrol et
        local gpio_ok=true
        for pin in 17 18 22 23; do
            if gpio read $pin &> /dev/null; then
                continue
            else
                gpio_ok=false
                break
            fi
        done

        if $gpio_ok; then
            echo -e "${GREEN}âœ… GPIO pinleri eriÅŸilebilir${NC}"
        else
            echo -e "${YELLOW}âš ï¸ BazÄ± GPIO pinleri eriÅŸilemiyor${NC}"
        fi
    else
        if $IS_DEV_CONTAINER; then
            echo -e "${BLUE}ğŸ® GPIO simÃ¼lasyonda kullanÄ±lmÄ±yor (normal)${NC}"
        else
            echo -e "${YELLOW}âš ï¸ GPIO araÃ§larÄ± yÃ¼klÃ¼ deÄŸil${NC}"
        fi
    fi

    # SensÃ¶r log dosyalarÄ±nÄ± kontrol et
    if $IS_DEV_CONTAINER; then
        echo -e "${BLUE}ğŸ® SensÃ¶r log dosyalarÄ± simÃ¼lasyonda oluÅŸturulacak${NC}"
    else
        check_file_age "logs/sensors.log" 10 "SensÃ¶r verisi"
        check_file_age "logs/imu.log" 15 "IMU verisi"
        # Ultrasonik sensÃ¶rler devre dÄ±ÅŸÄ±
    fi

    echo ""
}

check_network_status() {
    echo -e "${CYAN}ğŸŒ AÄ DURUMU${NC}"
    echo "============="

    # Ä°nternet baÄŸlantÄ±sÄ±
    if ping -c 1 8.8.8.8 &> /dev/null; then
        echo -e "${GREEN}âœ… Ä°nternet baÄŸlantÄ±sÄ± mevcut${NC}"
    else
        echo -e "${YELLOW}âš ï¸ Ä°nternet baÄŸlantÄ±sÄ± yok${NC}"
    fi

    # Wi-Fi durumu
    if command -v iwgetid &> /dev/null; then
        local wifi_ssid=$(iwgetid -r 2>/dev/null)
        if [[ -n "$wifi_ssid" ]]; then
            echo -e "${GREEN}âœ… Wi-Fi baÄŸlÄ±: $wifi_ssid${NC}"
        else
            echo -e "${YELLOW}âš ï¸ Wi-Fi baÄŸlantÄ±sÄ± yok${NC}"
        fi
    fi

    # Local IP adresi
    local local_ip=$(hostname -I | awk '{print $1}')
    if [[ -n "$local_ip" ]]; then
        echo -e "${GREEN}âœ… Yerel IP: $local_ip${NC}"
        echo "ğŸŒ Web arayÃ¼zÃ¼: http://$local_ip:5000"
    fi

    # SSH durumu
    if systemctl is-active --quiet ssh 2>/dev/null; then
        echo -e "${GREEN}âœ… SSH aktif${NC}"
    else
        echo -e "${YELLOW}âš ï¸ SSH aktif deÄŸil${NC}"
    fi

    echo ""
}

check_system_status() {
    echo -e "${CYAN}âš™ï¸ SÄ°STEM DURUMU${NC}"
    echo "================="

    # CPU kullanÄ±mÄ±
    if command -v top &> /dev/null; then
        local cpu_usage=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1)
        if [[ $(echo "$cpu_usage < 80" | bc 2>/dev/null || echo "1") -eq 1 ]]; then
            echo -e "${GREEN}âœ… CPU kullanÄ±mÄ±: %$cpu_usage${NC}"
        else
            echo -e "${YELLOW}âš ï¸ YÃ¼ksek CPU kullanÄ±mÄ±: %$cpu_usage${NC}"
        fi
    fi

    # Bellek kullanÄ±mÄ±
    if command -v free &> /dev/null; then
        local memory_info=$(free | grep '^Mem:' | awk '{printf "%.1f", $3/$2 * 100}')
        if [[ $(echo "$memory_info < 85" | bc 2>/dev/null || echo "1") -eq 1 ]]; then
            echo -e "${GREEN}âœ… Bellek kullanÄ±mÄ±: %$memory_info${NC}"
        else
            echo -e "${YELLOW}âš ï¸ YÃ¼ksek bellek kullanÄ±mÄ±: %$memory_info${NC}"
        fi
    fi

    # Disk kullanÄ±mÄ±
    local disk_usage=$(df . | tail -1 | awk '{print $5}' | sed 's/%//')
    if [[ $disk_usage -lt 80 ]]; then
        echo -e "${GREEN}âœ… Disk kullanÄ±mÄ±: %$disk_usage${NC}"
    else
        echo -e "${YELLOW}âš ï¸ YÃ¼ksek disk kullanÄ±mÄ±: %$disk_usage${NC}"
    fi

    # Sistem sÄ±caklÄ±ÄŸÄ± (Raspberry Pi)
    if [[ -f "/sys/class/thermal/thermal_zone0/temp" ]]; then
        local temp=$(cat /sys/class/thermal/thermal_zone0/temp)
        local temp_celsius=$((temp / 1000))
        if [[ $temp_celsius -lt 70 ]]; then
            echo -e "${GREEN}âœ… CPU sÄ±caklÄ±ÄŸÄ±: ${temp_celsius}Â°C${NC}"
        elif [[ $temp_celsius -lt 85 ]]; then
            echo -e "${YELLOW}âš ï¸ CPU sÄ±caklÄ±ÄŸÄ± yÃ¼ksek: ${temp_celsius}Â°C${NC}"
        else
            echo -e "${RED}âŒ CPU aÅŸÄ±rÄ± Ä±sÄ±nmÄ±ÅŸ: ${temp_celsius}Â°C${NC}"
        fi
    fi

    # Uptime
    local uptime_info=$(uptime -p 2>/dev/null || uptime)
    echo "â° Sistem Ã§alÄ±ÅŸma sÃ¼resi: $uptime_info"

    echo ""
}

check_logs_status() {
    echo -e "${CYAN}ğŸ“ LOG DURUMU${NC}"
    echo "=============="

    # Log klasÃ¶rÃ¼ kontrolÃ¼
    if [[ -d "logs" ]]; then
        local log_count=$(ls logs/*.log 2>/dev/null | wc -l)
        echo -e "${GREEN}âœ… $log_count log dosyasÄ± mevcut${NC}"

        # Log dosyasÄ± boyutlarÄ±
        echo ""
        echo "ğŸ“Š Log dosyasÄ± boyutlarÄ±:"
        for log_file in logs/*.log; do
            if [[ -f "$log_file" ]]; then
                local size=$(get_file_size "$log_file")
                local basename=$(basename "$log_file")
                echo "   $basename: $size"
            fi
        done

        # Son hata kontrolÃ¼
        local error_count=$(grep -i "error\|exception\|critical" logs/*.log 2>/dev/null | wc -l)
        if [[ $error_count -eq 0 ]]; then
            echo -e "${GREEN}âœ… Son zamanlarda hata bulunamadÄ±${NC}"
        else
            echo -e "${YELLOW}âš ï¸ $error_count hata/exception bulundu${NC}"
        fi

    else
        echo -e "${YELLOW}âš ï¸ Log klasÃ¶rÃ¼ bulunamadÄ±${NC}"
    fi

    echo ""
}

# Ana kontrol akÄ±ÅŸÄ±
case $CHECK_TYPE in
    "all")
        check_general_status
        check_battery_status
        check_gps_status
        check_sensors_status
        check_network_status
        check_system_status
        check_logs_status
        ;;
    "battery")
        check_battery_status
        ;;
    "gps")
        check_gps_status
        ;;
    "sensors")
        check_sensors_status
        ;;
    "network")
        check_network_status
        ;;
    "system")
        check_system_status
        ;;
    "logs")
        check_logs_status
        ;;
esac

# Ã–neriler
echo -e "${CYAN}ğŸ’¡ YARALI KOMUTLAR:${NC}"
echo "  oba-logs          Log dosyalarÄ±nÄ± gÃ¶rÃ¼ntÃ¼le"
echo "  oba-start         Robotu baÅŸlat"
echo "  oba-test          Sistem testleri Ã§alÄ±ÅŸtÄ±r"
echo "  oba-clean         GeÃ§ici dosyalarÄ± temizle"

echo ""
echo -e "${GREEN}âœ¨ Durum kontrolÃ¼ tamamlandÄ±!${NC}"

#!/bin/bash
# -*- codinecho "ğŸŒ± OBA TEST SÃœÄ°TÄ°"
echo "==================" utf-8 -*-
#
# Otonom BahÃ§e AsistanÄ± (OBA) - Test Suite Scripti
# =================================================
#
# Bu script test sÃ¼itlerini farklÄ± modlarda Ã§alÄ±ÅŸtÄ±rÄ±r.
#

# Proje ana dizinine git
SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "$0")")" && pwd)"
cd "${SCRIPT_DIR}/.."

# Renk kodlarÄ±
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Banner
echo -e "${CYAN}"
echo "ï¿½ OBA TEST SÃœÄ°TÄ°"
echo "=================="
echo -e "${NC}"

# Parametreleri kontrol et
TEST_MODULE=""
VERBOSE=false
QUICK=false
COVERAGE=false

for arg in "$@"; do
    case $arg in
        hardware|hw)
            TEST_MODULE="hardware"
            echo -e "${BLUE}ğŸ”§ DonanÄ±m testleri seÃ§ildi${NC}"
            ;;
        navigation|nav)
            TEST_MODULE="navigation"
            echo -e "${BLUE}ğŸ§­ Navigation testleri seÃ§ildi${NC}"
            ;;
        system|sys)
            TEST_MODULE="system"
            echo -e "${BLUE}âš™ï¸ Sistem testleri seÃ§ildi${NC}"
            ;;
        integration|int)
            TEST_MODULE="integration"
            echo -e "${BLUE}ğŸ”— Entegrasyon testleri seÃ§ildi${NC}"
            ;;
        quick|q)
            QUICK=true
            echo -e "${YELLOW}âš¡ HÄ±zlÄ± test modu aktif${NC}"
            ;;
        verbose|v)
            VERBOSE=true
            echo -e "${CYAN}ğŸ“ DetaylÄ± Ã§Ä±ktÄ± aktif${NC}"
            ;;
        coverage|cov)
            COVERAGE=true
            echo -e "${PURPLE}ğŸ“Š Coverage raporu aktif${NC}"
            ;;
        help|-h|--help)
            echo "KullanÄ±m: oba-test [seÃ§enekler]"
            echo ""
            echo "Test ModÃ¼lleri:"
            echo "  hardware, hw       DonanÄ±m testleri"
            echo "  navigation, nav    Navigation testleri"
            echo "  system, sys        Sistem testleri"
            echo "  integration, int   Entegrasyon testleri"
            echo ""
            echo "SeÃ§enekler:"
            echo "  quick, q          HÄ±zlÄ± testler (sadece kritik)"
            echo "  verbose, v        DetaylÄ± Ã§Ä±ktÄ±"
            echo "  coverage, cov     Coverage raporu"
            echo "  help              Bu yardÄ±mÄ± gÃ¶ster"
            echo ""
            echo "Ã–rnekler:"
            echo "  oba-test                  TÃ¼m testleri Ã§alÄ±ÅŸtÄ±r"
            echo "  oba-test hardware         DonanÄ±m testleri"
            echo "  oba-test quick            HÄ±zlÄ± testler"
            echo "  oba-test nav verbose      Navigation + detaylÄ±"
            exit 0
            ;;
        *)
            echo -e "${RED}âŒ Bilinmeyen parametre: $arg${NC}"
            echo "YardÄ±m iÃ§in: oba-test help"
            exit 1
            ;;
    esac
done

# Sistem kontrolleri
echo -e "${CYAN}ğŸ” Test ortamÄ± kontrolleri...${NC}"

# Python kontrolÃ¼
if ! command -v python3 &> /dev/null; then
    echo -e "${RED}âŒ Python3 bulunamadÄ±!${NC}"
    exit 1
fi

# Test klasÃ¶rÃ¼ kontrolÃ¼
echo "ğŸ” Mevcut dizin: $(pwd)"
echo "ğŸ“ Ä°Ã§erik: $(ls -1 | head -5)"
if [[ ! -d "tests" ]]; then
    echo -e "${RED}âŒ Test klasÃ¶rÃ¼ bulunamadÄ±!${NC}"
    exit 1
fi

# Log klasÃ¶rÃ¼nÃ¼ oluÅŸtur
if [[ ! -d "logs" ]]; then
    mkdir -p logs
    echo -e "${GREEN}âœ… Log klasÃ¶rÃ¼ oluÅŸturuldu${NC}"
fi

# Sanal ortam kontrolÃ¼ (dev container'da atla)
if [[ -f ".devcontainer/devcontainer.json" ]]; then
    echo -e "${GREEN}ğŸ³ Dev container ortamÄ±nda Ã§alÄ±ÅŸÄ±lÄ±yor${NC}"
elif [[ "$VIRTUAL_ENV" == "" ]]; then
    echo -e "${YELLOW}âš ï¸ Sanal ortam aktif deÄŸil${NC}"
    if [[ -f "venv/bin/activate" ]]; then
        source venv/bin/activate
        echo -e "${GREEN}âœ… Sanal ortam aktifleÅŸtirildi${NC}"
    fi
fi

# Test komutunu oluÅŸtur
if $COVERAGE; then
    # Coverage iÃ§in pytest kullan
    if command -v pytest &> /dev/null; then
        TEST_CMD="pytest tests/ --cov=src --cov-report=html --cov-report=term"
    else
        echo -e "${YELLOW}âš ï¸ pytest bulunamadÄ±, normal test runner kullanÄ±lÄ±yor${NC}"
        TEST_CMD="python3 tests/test_runner.py"
    fi
else
    TEST_CMD="python3 tests/test_runner.py"
fi

# ModÃ¼l parametresi ekle
if [[ -n "$TEST_MODULE" ]]; then
    TEST_CMD="$TEST_CMD --module $TEST_MODULE"
fi

# Verbose parametresi ekle
if $VERBOSE; then
    TEST_CMD="$TEST_CMD --verbose"
fi

# HÄ±zlÄ± test modu
if $QUICK; then
    echo -e "${YELLOW}âš¡ HÄ±zlÄ± test modu - sadece kritik testler Ã§alÄ±ÅŸacak${NC}"
    # HÄ±zlÄ± testler iÃ§in environment variable set et
    export QUICK_TESTS=true
fi

# Test baÅŸlangÄ±Ã§ bilgileri
echo -e "${CYAN}â„¹ï¸ Test bilgileri:${NC}"
echo "  ğŸ Python: $(python3 --version)"
echo "  ğŸ“ Test dizini: tests/"
echo "  ğŸ”§ Komut: $TEST_CMD"

if [[ -n "$TEST_MODULE" ]]; then
    echo "  ğŸ“¦ ModÃ¼l: $TEST_MODULE"
else
    echo "  ğŸ“¦ ModÃ¼l: TÃ¼mÃ¼"
fi

if $QUICK; then
    echo "  âš¡ Mod: HÄ±zlÄ± testler"
else
    echo "  ğŸ§ª Mod: Tam test suite"
fi

if $COVERAGE; then
    echo "  ğŸ“Š Coverage: Aktif"
fi

echo ""

# Test Ã¶ncesi sistem durumu
echo -e "${CYAN}ğŸ“Š Sistem durumu:${NC}"

# Bellek kullanÄ±mÄ±
if command -v free &> /dev/null; then
    MEMORY_INFO=$(free -h | grep '^Mem:' | awk '{print $3 "/" $2}')
    echo "  ğŸ’¾ Bellek: $MEMORY_INFO"
fi

# Disk alanÄ±
DISK_INFO=$(df -h . | tail -1 | awk '{print $4 " kullanÄ±labilir"}')
echo "  ğŸ’¿ Disk: $DISK_INFO"

# CPU bilgisi
if command -v nproc &> /dev/null; then
    CPU_COUNT=$(nproc)
    echo "  ğŸ”¥ CPU: $CPU_COUNT Ã§ekirdek"
fi

echo ""

# Ã–zel durumlar iÃ§in uyarÄ±lar
if [[ "$TEST_MODULE" == "hardware" ]] || [[ -z "$TEST_MODULE" ]]; then
    echo -e "${YELLOW}âš ï¸ DÄ°KKAT: DonanÄ±m testleri Ã§alÄ±ÅŸacak!${NC}"
    echo "   â€¢ Raspberry Pi dÄ±ÅŸÄ±nda Ã§alÄ±ÅŸÄ±yorsanÄ±z simÃ¼lasyon modu kullanÄ±lacak"
    echo "   â€¢ GPIO testleri root izni gerektirebilir"
    echo ""
fi

# Test Ã§alÄ±ÅŸtÄ±rma
echo -e "${GREEN}ğŸ§ª Testler baÅŸlatÄ±lÄ±yor...${NC}"
echo "   Durdurmak iÃ§in: Ctrl+C"
echo ""

# BaÅŸlangÄ±Ã§ zamanÄ±nÄ± kaydet
START_TIME=$(date +%s)

# Test komutunu Ã§alÄ±ÅŸtÄ±r
if $VERBOSE; then
    echo -e "${BLUE}ğŸ”§ Ã‡alÄ±ÅŸtÄ±rÄ±lan komut: $TEST_CMD${NC}"
    echo ""
fi

# Testleri Ã§alÄ±ÅŸtÄ±r ve Ã§Ä±kÄ±ÅŸ kodunu yakala
set +e  # Hata durumunda script'i durdurmaya
eval $TEST_CMD
TEST_EXIT_CODE=$?
set -e

# BitiÅŸ zamanÄ±nÄ± hesapla
END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))

echo ""
echo -e "${CYAN}ğŸ“Š Test Ã¶zeti:${NC}"
echo "  â±ï¸ SÃ¼re: ${DURATION} saniye"

# Ã‡Ä±kÄ±ÅŸ koduna gÃ¶re sonuÃ§
if [[ $TEST_EXIT_CODE -eq 0 ]]; then
    echo -e "${GREEN}âœ… TÃ¼m testler baÅŸarÄ±lÄ±!${NC}"

    # Coverage raporu varsa
    if $COVERAGE && [[ -d "htmlcov" ]]; then
        echo -e "${PURPLE}ğŸ“Š Coverage raporu: file://$(pwd)/htmlcov/index.html${NC}"
    fi

    # Log dosyasÄ± varsa
    if [[ -f "logs/genel_test_raporu.txt" ]]; then
        echo -e "${BLUE}ğŸ“ DetaylÄ± rapor: logs/genel_test_raporu.txt${NC}"
    fi

else
    echo -e "${RED}âŒ BazÄ± testler baÅŸarÄ±sÄ±z! (Ã‡Ä±kÄ±ÅŸ kodu: $TEST_EXIT_CODE)${NC}"

    # Hata loglarÄ± varsa
    if [[ -f "logs/test_errors.log" ]]; then
        echo -e "${RED}ğŸš¨ Hata detaylarÄ±: logs/test_errors.log${NC}"
    fi

    echo ""
    echo -e "${YELLOW}ğŸ’¡ Sorun giderme Ã¶nerileri:${NC}"
    echo "   â€¢ DetaylÄ± Ã§Ä±ktÄ± iÃ§in: oba-test verbose"
    echo "   â€¢ Sadece bir modÃ¼l test et: oba-test hardware"
    echo "   â€¢ Log dosyalarÄ±nÄ± kontrol et: oba-logs error"
fi

echo ""
echo -e "${CYAN}ğŸ¯ YararlÄ± komutlar:${NC}"
echo "  oba-logs                Test loglarÄ±nÄ± gÃ¶rÃ¼ntÃ¼le"
echo "  oba-test quick          HÄ±zlÄ± testler"
echo "  oba-test help           Test yardÄ±mÄ±"

exit $TEST_EXIT_CODE
